<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>üìö Image Stream</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=5,user-scalable=yes">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<style>
  *{box-sizing:border-box;margin:0;padding:0}
  body{
    font-family:'Poppins',sans-serif;
    background:linear-gradient(135deg,#0f172a,#1e293b);
    color:#fff;
    min-height:100vh;
    display:flex;
    flex-direction:column;
    align-items:center;
    padding-bottom:60px;
    overflow-y:scroll;
  }
  /* ---------- Top bar ---------- */
  #topBar{
    width:100%;padding:10px 16px;display:flex;align-items:center;gap:8px;
    background:rgba(255,255,255,0.08);backdrop-filter:blur(12px);
    box-shadow:0 2px 8px rgba(0,0,0,.3);position:sticky;top:0;z-index:1000;
  }
  #topBar button{
    border:none;cursor:pointer;border-radius:6px;font-size:.95rem;
    padding:6px 12px;transition:background .25s ease;
  }
  #searchBtn{background:#60a5fa;color:#fff}
  #searchBtn:hover{background:#3b82f6}
  #uploadBtn{background:#34d399;color:#fff}
  #uploadBtn:hover{background:#10b981}
  #backBtn{
    background:#64748b;color:#fff;display:none;margin-right:8px;
  }
  #backBtn:hover{background:#374151}
  #searchToggle{
    background:transparent;color:#60a5fa;font-size:1.2rem;width:auto;padding:0 4px;line-height:1;
  }
  #searchToggle.active{transform:rotate(90deg);transition:transform .2s}
  #searchMenu{
    position:absolute;top:calc(100% + 6px);left:0;
    background:rgba(15,23,42,.95);border:1px solid rgba(255,255,255,.2);
    border-radius:6px;padding:4px 0;display:none;min-width:120px;z-index:100;
  }
  #searchMenu.show{display:block}
  .search-filter-btn{
    background:none;border:none;color:#94a3b8;width:100%;text-align:left;
    padding:6px 12px;cursor:pointer;font-size:.85rem;
  }
  .search-filter-btn:hover{background:rgba(255,255,255,.1)}
  .search-filter-btn.active{color:#60a5fa}
  /* ---------- Feed ---------- */
  #feed{
    display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
    gap:16px;width:92%;max-width:1300px;margin-top:24px;
  }
  .card{
    background:rgba(255,255,255,0.08);border-radius:16px;padding:14px;
    display:flex;flex-direction:column;transition:transform .25s ease,box-shadow .25s ease;
  }
  .card:hover{
    transform:translateY(-4px);box-shadow:0 8px 20px rgba(0,0,0,.4);
  }
  .card.highlight{
    outline:3px solid #60a5fa;outline-offset:-2px;
  }
  .preview{
    width:100%;aspect-ratio:16/9;border-radius:12px;
    overflow:hidden;background:#1e293b;display:flex;align-items:center;justify-content:center;
  }
  .preview img{width:100%;height:100%;object-fit:cover}
  .preview-wrapper{position:relative;width:100%}
  .ellipsis-overlay{
    position:absolute;top:4px;left:4px;color:#ff4500;font-size:1.8em;font-weight:bold;pointer-events:none;
  }
  .info{margin-top:10px}
  .title{
    font-size:1em;font-weight:600;color:#f8fafc;margin-bottom:4px;line-height:1.4;word-break:break-word;
  }
  .meta{
    font-size:.85em;color:#94a3b8;word-break:break-word;
  }
  .action-bar{
    display:flex;align-items:center;margin-top:10px;
  }
  .share-btn{
    background:none;border:none;color:#94a3b8;cursor:pointer;
    font-size:1.2rem;margin-right:6px;transition:color .2s;
  }
  .share-btn:hover{color:#60a5fa}
  .open-btn{
    margin-top:0;background:#60a5fa;color:#fff;border:none;border-radius:8px;
    padding:10px;font-weight:500;cursor:pointer;transition:background .25s ease;
    font-size:.95em;flex-grow:1;
  }
  .open-btn:hover{background:#3b82f6}
  .loader{
    margin-top:60px;border:6px solid rgba(255,255,255,.2);
    border-top:6px solid #60a5fa;border-radius:50%;width:45px;height:45px;
    animation:spin 1s linear infinite;
  }
  @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
  footer{
    margin-top:30px;color:#94a3b8;font-size:.9em;text-align:center;
  }
  /* ---------- Full‚Äëscreen viewer ---------- */
  .pdf-viewer{
    position:fixed;inset:0;background:#0f172a;z-index:2000;
    display:none;flex-direction:column;
  }
  .pdf-viewer.active{display:flex}
  .pdf-toolbar{
    position:relative;
    display:flex;justify-content:space-between;align-items:center;
    padding:10px 14px;background:rgba(15,23,42,.9);
    border-bottom:1px solid rgba(255,255,255,.1);
    z-index:10;
  }
  .pdf-toolbar h2{
    margin:0;
    font-size:1em;color:#93c5fd;font-weight:500;
    overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:80%;
  }
  #closeViewer{
    position:absolute;top:12px;right:14px;
    background:#ef4444;border:none;color:#fff;font-size:1.2em;
    width:36px;height:36px;border-radius:50%;cursor:pointer;
    transition:background .25s ease;z-index:2005;
  }
  #closeViewer:hover{background:#dc2626}
  .pdf-content{
    flex-grow:1;overflow:auto;touch-action:none;
  }
  .pdf-iframe{
    width:100%;height:100%;border:none;display:block;
  }
  /* ---------- Full‚Äëscreen upload overlay ---------- */
  .full-screen{
    position:fixed;inset:0;background:#0f172a;z-index:2000;
    display:none;flex-direction:column;
  }
  .full-screen.active{display:flex}
  .upload-toolbar{
    position:relative;
    display:flex;justify-content:space-between;align-items:center;
    padding:10px 14px;background:rgba(15,23,42,.9);
    border-bottom:1px solid rgba(255,255,255,.1);
  }
  .upload-toolbar h2{
    margin:0;font-size:1rem;color:#93c5fd;
  }
  #closeUpload{
    background:#ef4444;border:none;color:#fff;font-size:1.2em;
    width:36px;height:36px;border-radius:50%;cursor:pointer;
    transition:background .25s ease;
  }
  #closeUpload:hover{background:#dc2626}
  /* ---- Upload overlay ‚Äì make iframe fill the whole space (100% width & height) ---- */
  .upload-content{
    flex:1;               /* take all remaining vertical space */
    display:flex;        /* turn it into a flex container */
    overflow:hidden;
  }
  .upload-iframe{
    flex:1;               /* fill the flex‚Äëcontainer */
    border:none;
  }
</style>
</head>

<body>
<!-- ---------- Top Bar ---------- -->
<div id="topBar">
  <button id="backBtn">‚Üê Back</button>
  <input type="text" id="searchInput" placeholder="Search by title..." autocomplete="off">
  <button id="searchBtn">Search</button>
  <button id="searchToggle">‚ñ∂</button>
  <div id="searchMenu">
    <button class="search-filter-btn" data-mode="id">ID</button>
    <button class="search-filter-btn" data-mode="username">Username</button>
  </div>
  <button id="uploadBtn">Upload</button>
</div>

<div id="feed"></div>
<div id="loader" class="loader"></div>

<footer>¬© 2026 Powered by Archive &amp; Your Backend</footer>

<!-- Full‚Äëscreen image viewer -->
<div id="pdfViewer" class="pdf-viewer">
  <div class="pdf-toolbar">
    <h2 id="pdfTitle">Image Viewer</h2>
    <button class="close-full" id="closeViewer">&times;</button>
  </div>
  <div class="pdf-content">
    <iframe id="pdfFrame" class="pdf-iframe" src=""></iframe>
  </div>
</div>

<!-- Full‚Äëscreen upload overlay -->
<div id="uploadOverlay" class="full-screen">
  <div class="upload-toolbar">
    <h2>Upload Images</h2>
    <button class="close-full" id="closeUpload">&times;</button>
  </div>
  <div class="upload-content">
    <iframe class="upload-iframe" src=""></iframe>
  </div>
</div>

<script>
/* ==================== UI references ==================== */
const FEED          = document.getElementById('feed');
const LOADER        = document.getElementById('loader');
const VIEWER        = document.getElementById('pdfViewer');
const PDF_FRAME     = document.getElementById('pdfFrame');
const PDF_TITLE     = document.getElementById('pdfTitle');
const CLOSE_VIEWER  = document.getElementById('closeViewer');

const SEARCH_INPUT      = document.getElementById('searchInput');
const SEARCH_BTN        = document.getElementById('searchBtn');
const SEARCH_TOGGLE     = document.getElementById('searchToggle');
const SEARCH_MENU       = document.getElementById('searchMenu');
const UPLOAD_BTN        = document.getElementById('uploadBtn');
const UPLOAD_OVERLAY    = document.getElementById('uploadOverlay');
const CLOSE_UPLOAD      = document.getElementById('closeUpload');
const BACK_BTN          = document.getElementById('backBtn');

/* ==================== Backend / Paging ==================== */
const BACKEND_URL = 'https://images_displaying_backend.erenyeager6880.workers.dev';
let allData = [];            // raw data from backend
let currentData = [];        // filtered view (null === all)
let displayedCount = 0;
let loading = false;
let searchMode = 'title';    // 'title' (default), 'id', 'username'
const BATCH_SIZE = 30;
const SHARE_BASE_URL = 'https://yan-1-related-1.github.io/yan-1-website-shared-links-redirecting/all-images-content-page-shared-links-redirecting.html';

/* ==================== URL handling ==================== */
const urlParams = new URLSearchParams(window.location.search);
const targetImageId = urlParams.get('image_id');   // may be null
let targetScrolled = false;

/* ==================== Helpers ==================== */
function getThumbnailUrl(item){
  if (item.archive_url && item.archive_url.includes('archive.org/details/')){
    const id = item.archive_url.split('/details/')[1]?.split(/[/?#]/)[0];
    if (id) return `https://archive.org/services/img/${id}`;
  }
  return '';
}
function getFullImageUrl(item){
  const raw = (item.archive_url||'').trim();
  if (!raw) return '';
  const low = raw.toLowerCase();
  if (/\.(png|jpe?g|gif|webp|svg)$/i.test(low)) return encodeURI(raw);
  if (raw.includes('archive.org/details/')){
    const id = raw.split('/details/')[1]?.split(/[/?#]/)[0];
    if (id) return encodeURI(`https://archive.org/download/${id}/${id}.jpg`);
  }
  return getThumbnailUrl(item);
}

/* ==================== Card creation ==================== */
function createCard(item){
  const card = document.createElement('div');
  card.className = 'card';
  card.dataset.id = item.id || '';

  // ----- thumbnail -----
  const thumbUrl = getThumbnailUrl(item);
  const preview = document.createElement('div');
  preview.className = 'preview';
  if (thumbUrl){
    preview.innerHTML = `<img src="${thumbUrl}" alt="Thumbnail" loading="lazy">`;
  }else{
    preview.textContent = 'No Preview Available';
  }
  const wrapper = document.createElement('div');
  wrapper.className = 'preview-wrapper';
  wrapper.appendChild(preview);
  const low = (item.archive_url||'').toLowerCase();
  if (low.endsWith('.png') || low.endsWith('.jpg')){
    const ellipsis = document.createElement('div');
    ellipsis.className = 'ellipsis-overlay';
    ellipsis.textContent = '...';
    wrapper.appendChild(ellipsis);
  }

  // ----- info -----
  const info = document.createElement('div');
  info.className = 'info';
  info.innerHTML = `
    <div class="title">${item.title || 'Untitled Image'}</div>
    <div class="meta">üë§ ${item.username || 'Anonymous'} ‚Ä¢ üÜî ${item.id || 'N/A'}</div>
  `;

  // ----- actions -----
  const actions = document.createElement('div');
  actions.className = 'action-bar';

  const shareBtn = document.createElement('button');
  shareBtn.className = 'share-btn';
  shareBtn.title = 'Share';
  shareBtn.innerHTML = 'üîó';
  shareBtn.onclick = (e)=>{
    e.stopPropagation();
    const link = `${SHARE_BASE_URL}?image_id=${encodeURIComponent(item.id)}`;
    if (navigator.share){
      navigator.share({title:item.title,url:link}).catch(err=>console.error('Share failed',err));
    }else if (navigator.clipboard && navigator.clipboard.writeText){
      navigator.clipboard.writeText(link).then(()=>alert('Link copied to clipboard'))
        .catch(()=>prompt('Copy this link',link));
    }else{
      prompt('Copy this link',link);
    }
  };

  const openBtn = document.createElement('button');
  openBtn.className = 'open-btn';
  openBtn.textContent = 'Open Image';
  openBtn.onclick = () => openFullscreenImage(item.title,item.archive_url);

  actions.append(shareBtn,openBtn);
  card.append(wrapper,info,actions);
  return card;
}

/* ==================== Rendering ==================== */
function renderNextBatch(){
  if (loading) return;
  loading = true;
  const batch = currentData.slice(displayedCount, displayedCount+BATCH_SIZE);
  batch.forEach(item=>{
    const card = createCard(item);
    FEED.appendChild(card);
    if (!targetScrolled && targetImageId && item.id && item.id===targetImageId){
      card.classList.add('highlight');
      setTimeout(()=>card.scrollIntoView({behavior:'smooth',block:'center'}),0);
      targetScrolled = true;
    }
  });
  displayedCount += batch.length;
  loading = false;
}
function renderAllData(){
  if (loading) return;
  loading = true;
  currentData.forEach(item=>{
    const card = createCard(item);
    FEED.appendChild(card);
    if (!targetScrolled && targetImageId && item.id && item.id===targetImageId){
      card.classList.add('highlight');
      setTimeout(()=>card.scrollIntoView({behavior:'smooth',block:'center'}),0);
      targetScrolled = true;
    }
  });
  displayedCount = currentData.length;
  loading = false;
}

/* ==================== Infinite scroll ==================== */
window.addEventListener('scroll',()=>{
  if (window.innerHeight+window.scrollY >= document.body.offsetHeight-200){
    if (displayedCount < currentData.length && !loading) renderNextBatch();
  }
});

/* ==================== Full‚Äëscreen viewer ==================== */
let currentScale = 1;
const MIN_SCALE = 0.5;
const MAX_SCALE = 5;
function applyScale(){
  PDF_FRAME.style.transform = `scale(${currentScale})`;
  PDF_FRAME.style.transformOrigin = '0 0';
}
function openFullscreenImage(title, archiveUrl){
  if (!archiveUrl) return;
  const embedUrl = archiveUrl.includes('archive.org')
        ? archiveUrl.replace('/details/','/embed/')
        : archiveUrl;
  PDF_TITLE.textContent = title || 'Image Viewer';
  PDF_FRAME.src = embedUrl;
  VIEWER.classList.add('active');
  currentScale = 1;
  applyScale();
}
function closeViewer(){
  VIEWER.classList.remove('active');
  PDF_FRAME.src = '';
  currentScale = 1;
  applyScale();
}
CLOSE_VIEWER.onclick = closeViewer;
document.addEventListener('keydown',e=>{
  if (e.key==='Escape'){
    if (VIEWER.classList.contains('active')) closeViewer();
    if (UPLOAD_OVERLAY.classList.contains('active')) closeUpload();
  }
});

/* ----- wheel zoom ----- */
const PDF_CONTENT = document.querySelector('.pdf-content');
PDF_CONTENT.addEventListener('wheel',e=>{
  e.preventDefault();
  const factor = e.deltaY<0 ? 1.1 : 0.9;
  const newScale = Math.min(MAX_SCALE, Math.max(MIN_SCALE, currentScale*factor));
  if (newScale!==currentScale){
    const rect = PDF_FRAME.getBoundingClientRect();
    const cx = e.clientX - rect.left;
    const cy = e.clientY - rect.top;
    const scrollL = PDF_CONTENT.scrollLeft;
    const scrollT = PDF_CONTENT.scrollTop;
    const ratio = newScale/currentScale;
    currentScale = newScale;
    applyScale();
    PDF_CONTENT.scrollLeft = (cx+scrollL)*ratio - cx;
    PDF_CONTENT.scrollTop  = (cy+scrollT)*ratio - cy;
  }
},{passive:false});

/* ----- pinch‚Äëzoom (touch) ----- */
let pinchStartDist = null;
let pinchStartScale = 1;
function getDist(t1,t2){
  const dx = t2.clientX - t1.clientX;
  const dy = t2.clientY - t1.clientY;
  return Math.hypot(dx,dy);
}
PDF_CONTENT.addEventListener('touchstart',e=>{
  if (e.touches.length===2){
    pinchStartDist = getDist(e.touches[0],e.touches[1]);
    pinchStartScale = currentScale;
    e.preventDefault();
  }
},{passive:false});
PDF_CONTENT.addEventListener('touchmove',e=>{
  if (e.touches.length===2 && pinchStartDist){
    const cur = getDist(e.touches[0],e.touches[1]);
    const scale = Math.min(MAX_SCALE, Math.max(MIN_SCALE, pinchStartScale * (cur/pinchStartDist)));
    if (scale!==currentScale){
      currentScale = scale;
      applyScale();
    }
    e.preventDefault();
  }
},{passive:false});
PDF_CONTENT.addEventListener('touchend',e=>{
  if (e.touches.length<2) pinchStartDist = null;
});

/* ==================== Upload overlay ==================== */
function openUploadOverlay(){
  /* -------------------------------------------------------------
     CHANGE: Previously this loaded *images_displaying.html*.  It now
     loads *images_uploading.html* (which resides in the same repo).
     The overlay already occupies the full viewport, and the iframe
     CSS above forces it to fill the whole space ‚Äì no more tiny grid.
     ------------------------------------------------------------- */
  UPLOAD_OVERLAY.classList.add('active');
  document.querySelector('.upload-iframe').src = 'images_uploading.html';
}
function closeUpload(){
  UPLOAD_OVERLAY.classList.remove('active');
  document.querySelector('.upload-iframe').src = '';
}
UPLOAD_BTN.onclick = openUploadOverlay;
CLOSE_UPLOAD.onclick = closeUpload;

/* ==================== Search / filter ==================== */
function applyFilter(){
  const query = SEARCH_INPUT.value.trim();

  // empty query + default mode ‚Üí full feed
  if (!query && searchMode==='title'){
    currentData = allData;
    BACK_BTN.style.display='none';
    FEED.innerHTML='';
    displayedCount=0;
    renderNextBatch();
    return;
  }

  if (searchMode==='title'){
    const q = query.toLowerCase();
    currentData = allData.filter(it=> (it.title||'').toLowerCase().includes(q));
  }else if (searchMode==='id'){
    const q = query.toLowerCase();
    currentData = allData.filter(it=> ((it.id??'').toString().toLowerCase()).includes(q));
  }else if (searchMode==='username'){
    const q = query.toLowerCase();
    currentData = allData.filter(it=> (it.username||'').toLowerCase().includes(q));
  }

  FEED.innerHTML='';
  displayedCount=0;
  renderNextBatch();
  BACK_BTN.style.display='inline-block';
}
SEARCH_BTN.addEventListener('click',applyFilter);
SEARCH_INPUT.addEventListener('keydown',e=>{if(e.key==='Enter')applyFilter();});

/* ---------- Back button ---------- */
BACK_BTN.addEventListener('click',()=>{
  SEARCH_INPUT.value='';
  searchMode='title';
  SEARCH_INPUT.placeholder='Search by title...';
  document.querySelectorAll('.search-filter-btn').forEach(b=>b.classList.remove('active'));
  SEARCH_MENU.classList.remove('show');
  SEARCH_TOGGLE.classList.remove('active');

  currentData = allData;
  FEED.innerHTML='';
  displayedCount=0;
  renderNextBatch();
  BACK_BTN.style.display='none';
  window.scrollTo({top:0,behavior:'smooth'});
});

/* ---------- Search menu toggle ---------- */
SEARCH_TOGGLE.addEventListener('click',()=>{
  const showing = SEARCH_MENU.classList.toggle('show');
  SEARCH_TOGGLE.classList.toggle('active',showing);
});

/* ---------- Filter selection (ID / Username) ---------- */
SEARCH_MENU.addEventListener('click',e=>{
  if (e.target.classList.contains('search-filter-btn')){
    const mode = e.target.dataset.mode;
    if (mode){
      if (searchMode===mode){
        searchMode='title';
        SEARCH_INPUT.placeholder='Search by title...';
        e.target.classList.remove('active');
      }else{
        searchMode=mode;
        SEARCH_INPUT.placeholder = mode==='id' ? 'Enter ID...' : 'Enter username...';
        document.querySelectorAll('.search-filter-btn').forEach(b=>b.classList.remove('active'));
        e.target.classList.add('active');
      }
      SEARCH_MENU.classList.remove('show');
      SEARCH_TOGGLE.classList.remove('active');
    }
  }
});

/* ==================== Direct‚Äëlink handling ==================== */
function openImageById(id){
  const item = allData.find(it=> (it.id??'').toString()===id);
  if (item){
    openFullscreenImage(item.title,item.archive_url);
  }
}

/* ==================== Fetch data ==================== */
async function fetchData(){
  try{
    const resp = await fetch(BACKEND_URL);
    const data = await resp.json();
    LOADER.style.display='none';
    if (!data || !data.length){
      FEED.innerHTML="<p style='text-align:center;color:#94a3b8'>No Images found üò¢</p>";
      return;
    }
    allData = data;
    currentData = allData;

    if (targetImageId){
      // Build the whole feed so the target card exists
      renderAllData();

      // Find the matching item
      const targetItem = allData.find(it=> (it.id??'').toString()===targetImageId);
      if (targetItem){
        // Ensure the card is scrolled into view (highlight already added)
        const cardEl = document.querySelector(`.card[data-id="${targetImageId}"]`);
        if (cardEl){
          cardEl.scrollIntoView({behavior:'smooth',block:'center'});
        }
        // Open the viewer a short moment after the scroll starts
        setTimeout(()=>openFullscreenImage(targetItem.title,targetItem.archive_url), 600);
      }
    }else{
      renderNextBatch();
    }
  }catch(err){
    LOADER.style.display='none';
    FEED.innerHTML="<p style='text-align:center;color:#f87171'>Error loading data üòû</p>";
    console.error(err);
  }
}
fetchData();
</script>
</body>
</html>
