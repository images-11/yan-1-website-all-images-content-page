<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport"
      content="width=device-width,initial-scale=1.0,maximum-scale=5,user-scalable=yes" />
<title>üìö Image Stream</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap"
      rel="stylesheet">

<style>
  *{box-sizing:border-box;margin:0;padding:0;}
  body{
    font-family:'Poppins',sans-serif;
    background:linear-gradient(135deg,#0f172a,#1e293b);
    color:#fff;
    min-height:100vh;
    display:flex;
    flex-direction:column;
    align-items:center;
    padding-bottom:60px;
  }
  /* ---------- Top bar ---------- */
  #topBar{
    width:100%;
    padding:10px 16px;
    display:flex;
    align-items:center;
    gap:8px;
    background:rgba(255,255,255,0.08);
    backdrop-filter:blur(12px);
    box-shadow:0 2px 8px rgba(0,0,0,.3);
    position:sticky;
    top:0;
    z-index:1000;
  }
  #topBar button{
    border:none;
    cursor:pointer;
    border-radius:6px;
    font-size:.95rem;
    padding:6px 12px;
    transition:background .25s ease;
  }
  #searchBtn{background:#60a5fa;color:#fff;}
  #searchBtn:hover{background:#3b82f6;}
  #uploadBtn{background:#34d399;color:#fff;}
  #uploadBtn:hover{background:#10b981;}
  #backBtn{
    background:#64748b;color:#fff;display:none;margin-right:8px;
  }
  #backBtn:hover{background:#374151;}
  #searchToggle{
    background:transparent;color:#60a5fa;font-size:1.2rem;width:auto;padding:0 4px;line-height:1;
  }
  #searchToggle.active{transform:rotate(90deg);transition:transform .2s;}
  #searchMenu{
    position:absolute;top:calc(100% + 6px);left:0;
    background:rgba(15,23,42,.95);border:1px solid rgba(255,255,255,.2);
    border-radius:6px;padding:4px 0;display:none;min-width:120px;z-index:100;
  }
  #searchMenu.show{display:block;}
  .search-filter-btn{
    background:none;border:none;color:#94a3b8;width:100%;text-align:left;
    padding:6px 12px;cursor:pointer;font-size:.85rem;
  }
  .search-filter-btn:hover{background:rgba(255,255,255,.1);}
  .search-filter-btn.active{color:#60a5fa;}
  /* ---------- Feed ---------- */
  #feed{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
    gap:16px;width:92%;max-width:1300px;margin-top:24px;
  }
  .card{
    background:rgba(255,255,255,0.08);border-radius:16px;padding:14px;
    display:flex;flex-direction:column;transition:transform .25s ease,box-shadow .25s ease;
  }
  .card:hover{
    transform:translateY(-4px);box-shadow:0 8px 20px rgba(0,0,0,.4);
  }
  .card.highlight{
    outline:3px solid #60a5fa;outline-offset:-2px;
  }
  .preview{
    width:100%;aspect-ratio:16/9;border-radius:12px;
    overflow:hidden;background:#1e293b;display:flex;align-items:center;justify-content:center;
  }
  .preview img{width:100%;height:100%;object-fit:cover;}
  .preview-wrapper{position:relative;width:100%;}
  .ellipsis-overlay{
    position:absolute;top:4px;left:4px;color:#ff4500;
    font-size:1.8em;font-weight:bold;pointer-events:none;
  }
  .info{margin-top:10px;}
  .title{
    font-size:1em;font-weight:600;color:#f8fafc;margin-bottom:4px;line-height:1.4;
    word-break:break-word;
  }
  .meta{
    font-size:.85em;color:#94a3b8;word-break:break-word;
  }
  .action-bar{
    display:flex;align-items:center;margin-top:10px;
  }
  .share-btn{
    background:none;border:none;color:#94a3b8;cursor:pointer;
    font-size:1.2rem;margin-right:6px;transition:color .2s;
  }
  .share-btn:hover{color:#60a5fa;}
  .open-btn{
    margin-top:0;background:#60a5fa;color:#fff;border:none;border-radius:8px;
    padding:10px;font-weight:500;cursor:pointer;transition:background .25s ease;
    font-size:.95em;flex-grow:1;
  }
  .open-btn:hover{background:#3b82f6;}
  .loader{
    margin-top:60px;border:6px solid rgba(255,255,255,.2);
    border-top:6px solid #60a5fa;border-radius:50%;width:45px;height:45px;
    animation:spin 1s linear infinite;
  }
  @keyframes spin{0%{transform:rotate(0);}100%{transform:rotate(360deg);}}
  footer{
    margin-top:30px;color:#94a3b8;font-size:.9em;text-align:center;
  }
  /* ---------- Full‚Äëscreen image viewer ---------- */
  .pdf-viewer{
    position:fixed;inset:0;background:#0f172a;z-index:999;
    display:none;flex-direction:column;
  }
  .pdf-viewer.active{display:flex;}
  .pdf-toolbar{
    display:flex;justify-content:space-between;align-items:center;
    padding:10px 14px;background:rgba(15,23,42,.9);
    border-bottom:1px solid rgba(255,255,255,.1);
  }
  .pdf-toolbar h2{
    font-size:1em;color:#93c5fd;font-weight:500;
    overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:80%;
  }
  .close-full{
    background:#ef4444;border:none;color:#fff;font-size:1.2em;
    width:36px;height:36px;border-radius:50%;cursor:pointer;
    transition:background .25s ease;
  }
  .close-full:hover{background:#dc2626;}
  .pdf-content{
    flex-grow:1;overflow:auto;touch-action:none;
  }
  .pdf-iframe{
    width:100%;height:100%;border:none;display:block;
  }
  /* ---------- Full‚Äëscreen upload overlay ---------- */
  .full-screen{
    position:fixed;inset:0;background:#0f172a;z-index:999;
    display:none;flex-direction:column;
  }
  .full-screen.active{display:flex;}
  .upload-toolbar{
    display:flex;justify-content:space-between;align-items:center;
    padding:10px 14px;background:rgba(15,23,42,.9);
    border-bottom:1px solid rgba(255,255,255,.1);
  }
  .upload-toolbar h2{
    font-size:1rem;color:#93c5fd;margin:0;
  }
</style>
</head>

<body>
<!-- ---------- Top Bar (search + upload) ---------- -->
<div id="topBar">
  <button id="backBtn">‚Üê Back</button>
  <input type="text" id="searchInput" placeholder="Search by title..." autocomplete="off" />
  <button id="searchBtn">Search</button>
  <button id="searchToggle">‚ñ∂</button>
  <div id="searchMenu">
    <button class="search-filter-btn" data-mode="id">ID</button>
    <button class="search-filter-btn" data-mode="username">Username</button>
  </div>
  <button id="uploadBtn">Upload</button>
</div>

<div id="feed"></div>
<div id="loader" class="loader"></div>

<footer>¬© 2026 Powered by Archive &amp; Your Backend</footer>

<!-- Fullscreen Image Viewer -->
<div id="pdfViewer" class="pdf-viewer">
  <div class="pdf-toolbar">
    <h2 id="pdfTitle">Image Viewer</h2>
    <button class="close-full" id="closeViewer">&times;</button>
  </div>
  <div class="pdf-content">
    <iframe id="pdfFrame" class="pdf-iframe" src=""></iframe>
  </div>
</div>

<!-- Full‚Äëscreen Upload Overlay -->
<div id="uploadOverlay" class="full-screen">
  <div class="upload-toolbar">
    <h2>Upload Images</h2>
    <button class="close-full" id="closeUpload">&times;</button>
  </div>
  <div class="upload-content">
    <iframe class="upload-iframe" src=""></iframe>
  </div>
</div>

<script>
/* --------------------------------------------------------------
   UI references
-------------------------------------------------------------- */
const FEED          = document.getElementById('feed');
const LOADER        = document.getElementById('loader');
const VIEWER        = document.getElementById('pdfViewer');
const PDF_FRAME     = document.getElementById('pdfFrame');
const PDF_TITLE     = document.getElementById('pdfTitle');
const CLOSE_VIEWER  = document.getElementById('closeViewer');

const SEARCH_INPUT      = document.getElementById('searchInput');
const SEARCH_BTN        = document.getElementById('searchBtn');
const SEARCH_TOGGLE     = document.getElementById('searchToggle');
const SEARCH_MENU       = document.getElementById('searchMenu');
const UPLOAD_BTN        = document.getElementById('uploadBtn');
const UPLOAD_OVERLAY    = document.getElementById('uploadOverlay');
const CLOSE_UPLOAD      = document.getElementById('closeUpload');
const BACK_BTN          = document.getElementById('backBtn');

/* --------------------------------------------------------------
   Backend / paging
-------------------------------------------------------------- */
const BACKEND_URL = 'https://images_displaying_backend.erenyeager6880.workers.dev';
let allData = [],                 // raw data from backend
    currentData = [],             // data after filter (null = all)
    displayedCount = 0,
    loading = false,
    searchMode = 'title';         // 'title' (default), 'id', 'username'
const BATCH_SIZE = 30;

const SHARE_BASE_URL = 'https://yan-1-related-1.github.io/yan-1-website-shared-links-redirecting/all-images-content-page-shared-links-redirecting.html';

/* --------------------------------------------------------------
   Query‚Äëstring handling (for direct links)
-------------------------------------------------------------- */
const urlParams = new URLSearchParams(window.location.search);
const targetImageId = urlParams.get('image_id');   // may be null
let targetScrolled = false;

/* --------------------------------------------------------------
   Helper ‚Äì thumbnail URL
-------------------------------------------------------------- */
function getThumbnailUrl(item){
  if (item.archive_url && item.archive_url.includes('archive.org/details/')){
    const id = item.archive_url.split('/details/')[1]?.split(/[/?#]/)[0];
    if (id) return `https://archive.org/services/img/${id}`;
  }
  return '';
}

/* --------------------------------------------------------------
   Helper ‚Äì full‚Äëimage URL (direct file or guessed)
-------------------------------------------------------------- */
function getFullImageUrl(item){
  const raw = (item.archive_url || '').trim();
  if (!raw) return '';
  const low = raw.toLowerCase();

  // direct image file
  if (/\.(png|jpe?g|gif|webp|svg)$/i.test(low)) {
    return encodeURI(raw);
  }

  // archive.org details ‚Üí guess a JPG
  if (raw.includes('archive.org/details/')) {
    const id = raw.split('/details/')[1]?.split(/[/?#]/)[0];
    if (id) return encodeURI(`https://archive.org/download/${id}/${id}.jpg`);
  }

  // fallback thumbnail
  return getThumbnailUrl(item);
}

/* --------------------------------------------------------------
   Card creation (used by both batch & full render)
-------------------------------------------------------------- */
function createCard(item){
  const card = document.createElement('div');
  card.className = 'card';
  card.dataset.id = item.id || '';

  /* ----- thumbnail preview (with optional ‚Äú...‚Äù overlay) ----- */
  const thumbUrl = getThumbnailUrl(item);
  const preview = document.createElement('div');
  preview.className = 'preview';
  if (thumbUrl){
    preview.innerHTML = `<img src="${thumbUrl}" alt="Thumbnail" loading="lazy">`;
  }else{
    preview.textContent = 'No Preview Available';
  }
  const wrapper = document.createElement('div');
  wrapper.className = 'preview-wrapper';
  wrapper.appendChild(preview);

  const low = (item.archive_url||'').toLowerCase();
  if (low.endsWith('.png') || low.endsWith('.jpg')){
    const ellipsis = document.createElement('div');
    ellipsis.className = 'ellipsis-overlay';
    ellipsis.textContent = '...';
    wrapper.appendChild(ellipsis);
  }

  /* ----- info block ----- */
  const info = document.createElement('div');
  info.className = 'info';
  info.innerHTML = `
    <div class="title">${item.title || 'Untitled Image'}</div>
    <div class="meta">üë§ ${item.username || 'Anonymous'} ‚Ä¢ üÜî ${item.id || 'N/A'}</div>
  `;

  /* ----- actions (share + open) ----- */
  const actions = document.createElement('div');
  actions.className = 'action-bar';

  // Share button (tiny)
  const shareBtn = document.createElement('button');
  shareBtn.className = 'share-btn';
  shareBtn.title = 'Share';
  shareBtn.innerHTML = 'üîó';
  shareBtn.onclick = (e) => {
    e.stopPropagation();
    const link = `${SHARE_BASE_URL}?image_id=${encodeURIComponent(item.id)}`;
    if (navigator.share){
      navigator.share({title: item.title, url: link}).catch(err=>console.error('Share failed', err));
    }else if (navigator.clipboard && navigator.clipboard.writeText){
      navigator.clipboard.writeText(link).then(()=>alert('Link copied to clipboard'))
        .catch(err=>{console.error('Copy failed',err);prompt('Copy this link',link);});
    }else{
      prompt('Copy this link', link);
    }
  };

  // Open button (full‚Äëscreen viewer)
  const openBtn = document.createElement('button');
  openBtn.className = 'open-btn';
  openBtn.textContent = 'Open Image';
  openBtn.onclick = () => openFullscreenImage(item.title, item.archive_url);

  actions.appendChild(shareBtn);
  actions.appendChild(openBtn);

  // Assemble card
  card.append(wrapper, info, actions);
  return card;
}

/* --------------------------------------------------------------
   Render a batch of cards (30 at a time)
-------------------------------------------------------------- */
function renderNextBatch(){
  if (loading) return;
  loading = true;

  const batch = currentData.slice(displayedCount, displayedCount + BATCH_SIZE);
  batch.forEach(item => {
    const card = createCard(item);
    FEED.appendChild(card);

    // Highlight + scroll to target if we arrived via a shared link
    if (!targetScrolled && targetImageId && item.id && item.id === targetImageId){
      card.classList.add('highlight');
      setTimeout(()=>card.scrollIntoView({behavior:'smooth',block:'center'}),0);
      targetScrolled = true;
    }
  });

  displayedCount += batch.length;
  loading = false;
}

/* --------------------------------------------------------------
   Render all cards (used when a direct link is opened)
-------------------------------------------------------------- */
function renderAllData(){
  if (loading) return;
  loading = true;
  currentData.forEach(item => {
    const card = createCard(item);
    FEED.appendChild(card);
    if (!targetScrolled && targetImageId && item.id && item.id === targetImageId){
      card.classList.add('highlight');
      setTimeout(()=>card.scrollIntoView({behavior:'smooth',block:'center'}),0);
      targetScrolled = true;
    }
  });
  displayedCount = currentData.length;
  loading = false;
}

/* --------------------------------------------------------------
   Infinite scroll (uses the filtered list)
-------------------------------------------------------------- */
window.addEventListener('scroll', () => {
  if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 200) {
    if (displayedCount < currentData.length && !loading) renderNextBatch();
  }
});

/* --------------------------------------------------------------
   Full‚Äëscreen image viewer (unchanged)
-------------------------------------------------------------- */
let currentScale = 1;
const MIN_SCALE = 0.5;
const MAX_SCALE = 5;

function applyScale(){
  PDF_FRAME.style.transform = `scale(${currentScale})`;
  PDF_FRAME.style.transformOrigin = '0 0';
}

/* open image in fullscreen viewer */
function openFullscreenImage(title, archiveUrl){
  if (!archiveUrl) return;
  const embedUrl = archiveUrl.includes('archive.org')
        ? archiveUrl.replace('/details/','/embed/')
        : archiveUrl;
  PDF_TITLE.textContent = title || 'Image Viewer';
  PDF_FRAME.src = embedUrl;
  VIEWER.classList.add('active');
  currentScale = 1;
  applyScale();
}

/* close viewer */
function closeViewer(){
  VIEWER.classList.remove('active');
  PDF_FRAME.src = '';
  currentScale = 1;
  applyScale();
}
CLOSE_VIEWER.onclick = closeViewer;
document.addEventListener('keydown', e => {
  if (e.key === 'Escape'){
    if (VIEWER.classList.contains('active')) closeViewer();
    if (UPLOAD_OVERLAY.classList.contains('active')) closeUpload();
  }
});

/* ----- wheel zoom ----- */
const PDF_CONTENT = document.querySelector('.pdf-content');
PDF_CONTENT.addEventListener('wheel', e => {
  e.preventDefault();
  const factor = e.deltaY < 0 ? 1.1 : 0.9;
  const newScale = Math.min(MAX_SCALE, Math.max(MIN_SCALE, currentScale * factor));
  if (newScale !== currentScale){
    const rect = PDF_FRAME.getBoundingClientRect();
    const cx = e.clientX - rect.left;
    const cy = e.clientY - rect.top;
    const scrollL = PDF_CONTENT.scrollLeft;
    const scrollT = PDF_CONTENT.scrollTop;
    const ratio = newScale / currentScale;
    currentScale = newScale;
    applyScale();
    PDF_CONTENT.scrollLeft = (cx + scrollL) * ratio - cx;
    PDF_CONTENT.scrollTop  = (cy + scrollT) * ratio - cy;
  }
},{passive:false});

/* ----- pinch‚Äëzoom (touch) ----- */
let pinchStartDist = null;
let pinchStartScale = 1;
function getDist(t1,t2){
  const dx = t2.clientX - t1.clientX;
  const dy = t2.clientY - t1.clientY;
  return Math.hypot(dx,dy);
}
PDF_CONTENT.addEventListener('touchstart', e => {
  if (e.touches.length===2){
    pinchStartDist = getDist(e.touches[0], e.touches[1]);
    pinchStartScale = currentScale;
    e.preventDefault();
  }
},{passive:false});
PDF_CONTENT.addEventListener('touchmove', e => {
  if (e.touches.length===2 && pinchStartDist){
    const curDist = getDist(e.touches[0], e.touches[1]);
    const scaleFactor = curDist / pinchStartDist;
    const newScale = Math.min(MAX_SCALE, Math.max(MIN_SCALE, pinchStartScale * scaleFactor));
    if (newScale !== currentScale){
      currentScale = newScale;
      applyScale();
    }
    e.preventDefault();
  }
},{passive:false});
PDF_CONTENT.addEventListener('touchend', e => {
  if (e.touches.length<2) pinchStartDist = null;
});

/* --------------------------------------------------------------
   Upload overlay handling
-------------------------------------------------------------- */
function openUploadOverlay(){
  UPLOAD_OVERLAY.classList.add('active');
  const iframe = document.querySelector('.upload-iframe');
  iframe.src = 'images_uploading.html';
}
function closeUpload(){
  UPLOAD_OVERLAY.classList.remove('active');
  const iframe = document.querySelector('.upload-iframe');
  iframe.src = '';
}
UPLOAD_BTN.onclick = openUploadOverlay;
CLOSE_UPLOAD.onclick = closeUpload;

/* --------------------------------------------------------------
   Search / filter handling (fixed ID‚Äësearch)
-------------------------------------------------------------- */
function applyFilter(){
  const query = SEARCH_INPUT.value.trim();

  // No query ‚Üí reset to full list (only when we‚Äôre in the default ‚Äútitle‚Äù mode)
  if (!query && searchMode === 'title'){
    currentData = allData;
    BACK_BTN.style.display = 'none';
    FEED.innerHTML = '';
    displayedCount = 0;
    renderNextBatch();
    return;
  }

  // Build filtered list based on the current mode
  if (searchMode === 'title'){
    const q = query.toLowerCase();
    currentData = allData.filter(item => (item.title||'').toLowerCase().includes(q));
  }else if (searchMode === 'id'){
    // IDs can be numeric ‚Äì compare as strings and allow partial matches
    const q = query.toLowerCase();
    currentData = allData.filter(item => {
      const idStr = (item.id ?? '').toString().toLowerCase();
      return idStr.includes(q);
    });
  }else if (searchMode === 'username'){
    const q = query.toLowerCase();
    currentData = allData.filter(item => (item.username||'').toLowerCase().includes(q));
  }

  // Show filtered results
  FEED.innerHTML = '';
  displayedCount = 0;
  renderNextBatch();

  // Show back button so the user can return to the full feed
  BACK_BTN.style.display = 'inline-block';
}

/* search button */
SEARCH_BTN.addEventListener('click', applyFilter);

/* hit Enter inside input */
SEARCH_INPUT.addEventListener('keydown', e => {
  if (e.key === 'Enter') applyFilter();
});

/* Back button ‚Äì returns to the unfiltered view */
BACK_BTN.addEventListener('click', () => {
  SEARCH_INPUT.value = '';
  searchMode = 'title';
  SEARCH_INPUT.placeholder = 'Search by title...';
  document.querySelectorAll('.search-filter-btn').forEach(btn=>btn.classList.remove('active'));
  SEARCH_MENU.classList.remove('show');
  SEARCH_TOGGLE.classList.remove('active');

  currentData = allData;
  FEED.innerHTML = '';
  displayedCount = 0;
  renderNextBatch();
  BACK_BTN.style.display = 'none';
  window.scrollTo({top:0, behavior:'smooth'});
});

/* toggle extra‚Äëfilter menu */
SEARCH_TOGGLE.addEventListener('click', () => {
  const showing = SEARCH_MENU.classList.toggle('show');
  SEARCH_TOGGLE.classList.toggle('active', showing);
});

/* extra‚Äëfilter buttons (ID / Username) */
SEARCH_MENU.addEventListener('click', e => {
  if (e.target.classList.contains('search-filter-btn')){
    const mode = e.target.dataset.mode;
    if (mode){
      // toggle off if already selected
      if (searchMode === mode){
        searchMode = 'title';
        SEARCH_INPUT.placeholder = 'Search by title...';
        e.target.classList.remove('active');
      }else{
        searchMode = mode;
        // set placeholder appropriate to the chosen mode
        if (mode === 'id') SEARCH_INPUT.placeholder = 'Enter ID...';
        else if (mode === 'username') SEARCH_INPUT.placeholder = 'Enter username...';
        document.querySelectorAll('.search-filter-btn').forEach(btn=>btn.classList.remove('active'));
        e.target.classList.add('active');
      }
      // hide the extra‚Äëfilter menu after a click
      SEARCH_MENU.classList.remove('show');
      SEARCH_TOGGLE.classList.remove('active');
    }
  }
});

/* --------------------------------------------------------------
   Kick‚Äëoff ‚Äì fetch JSON data
-------------------------------------------------------------- */
async function fetchData(){
  try{
    const res  = await fetch(BACKEND_URL);
    const data = await res.json();
    LOADER.style.display = 'none';
    if (!data || !data.length){
      FEED.innerHTML = "<p style='text-align:center;color:#94a3b8'>No Images found üò¢</p>";
      return;
    }
    allData = data;
    currentData = allData;      // start with everything

    if (targetImageId){
      // render everything so we can scroll to the shared card
      renderAllData();
    }else{
      renderNextBatch();
    }
  }catch(e){
    LOADER.style.display = 'none';
    FEED.innerHTML = "<p style='text-align:center;color:#f87171'>Error loading data üòû</p>";
    console.error(e);
  }
}
fetchData();
</script>
</body>
</html>
